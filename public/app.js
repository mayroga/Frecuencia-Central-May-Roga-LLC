// File: public/app.js
// Frontend logic: controla sesiones gratis, sesiones completas, VIP flow, micro-upsells y reproducción TTS/Audio
const freeBtn = document.getElementById('freeBtn');
const fullBtn = document.getElementById('fullBtn');
const vipBtn = document.getElementById('vipBtn');
const moodEl = document.getElementById('mood');
const voiceEl = document.getElementById('voice');
const audioEl = document.getElementById('audio');
const chatEl = document.getElementById('chat');
const upsellBtns = document.querySelectorAll('.upsellBtn');

function logChat(sender, text){
  const p = document.createElement('div');
  p.innerHTML = `<strong>${sender}:</strong> ${text}`;
  chatEl.appendChild(p);
  chatEl.scrollTop = chatEl.scrollHeight;
}

// helper to call /ai-response and play returned audio
async function callAIAndPlay(prompt, voice){
  try{
    logChat('Sistema', 'Generando respuesta de IA...');
    const res = await fetch('/ai-response', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ prompt, voice })
    });
    const data = await res.json();
    if(data.audio_url){
      audioEl.src = data.audio_url;
      await audioEl.play().catch(()=>{ /* autoplay policy */ });
      logChat(voice, prompt);
    } else {
      logChat('Error', 'No se pudo generar audio');
    }
  } catch(err){
    logChat('Error', err.message);
  }
}

// Free 30s session
freeBtn.onclick = async () => {
  const mood = moodEl.value;
  const voice = voiceEl.value;
  logChat('Usuario', `Inicia sesión gratis 30s - ${mood} - atendido por ${voice}`);
  // AI greeting
  await callAIAndPlay(`Bienvenido. Iniciando sesión gratuita de 30 segundos para estado ${mood}. Respira profundo.`, voice);
  // play a short frequency audio generated by server as TTS or static sample
  setTimeout(()=> {
    logChat('Sistema', 'Sesión gratuita finalizada.');
  }, 30000);
};

// Full session (charge via Stripe)
fullBtn.onclick = async () => {
  const mood = moodEl.value;
  const voice = voiceEl.value;
  // amount dynamic: base example $50 = 5000 cents. Could be adjusted based on mood or plan
  const amount = 5000;
  const body = { amount, description: `Sesión completa ${mood}`, metadata: { actionType: 'full_session', mood, voice } };
  const res = await fetch('/create-checkout-session', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  const data = await res.json();
  if(data.url){
    window.location.href = data.url;
  } else {
    logChat('Error', 'No se pudo iniciar pago');
  }
};

// VIP button - two-step: initial $10k then $5k donation
vipBtn.onclick = async () => {
  const voice = voiceEl.value;
  // step 1 - initial $10k
  const res = await fetch('/create-vip-checkout', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ step:'initial' })
  });
  const data = await res.json();
  if(data.url){
    // redirect user to pay initial $10k
    window.location.href = data.url;
  } else {
    logChat('Error', 'No se pudo iniciar VIP');
  }
};

// Upsells
upsellBtns.forEach(b=>{
  b.addEventListener('click', async (e)=>{
    const type = e.currentTarget.dataset.type;
    const body = { type, mood: moodEl.value, voice: voiceEl.value };
    const res = await fetch('/create-upsell-checkout', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const d = await res.json();
    if(d.url) window.location.href = d.url;
    else logChat('Error', 'No se pudo iniciar pago de upsell');
  });
});

// Auto-detect language helper (placeholder, can be improved)
async function detectLanguageAndGreet(){
  // Attempt to use browser language
  const lang = navigator.language || navigator.userLanguage || 'es';
  logChat('Sistema', `Idioma detectado: ${lang}`);
}
detectLanguageAndGreet();
