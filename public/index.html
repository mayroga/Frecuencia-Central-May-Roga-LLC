<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Frecuencia Central - Comunicaci√≥n Bidireccional</title>
<style>
body{font-family:Arial,sans-serif;padding:20px;background:#111;color:#eee;}
textarea{width:100%;height:100px;margin-bottom:10px;font-size:1.1rem;}
button{padding:10px 15px;margin:5px;font-size:1rem;}
#output{margin-top:20px;padding:10px;border:1px solid #333;height:150px;overflow-y:auto;}
</style>
</head>
<body>

<h1>Frecuencia Central - Comunicaci√≥n</h1>

<textarea id="txtInput" placeholder="Escribe tu mensaje aqu√≠..."></textarea><br>
<button id="btnSpeak">Reproducir voz</button>
<button id="btnListen">Hablar</button>

<div id="output"></div>

<script>
let recognition;
if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.lang = 'es-ES';
}

// Funci√≥n para limpiar texto
function cleanText(text){
    return text.replace(/[\*\(\),]/g,'').trim();
}

// Funci√≥n para hablar
function speakText(text, lang='es-ES'){
    const clean = cleanText(text);
    if(!clean) return;
    const utter = new SpeechSynthesisUtterance(clean);
    utter.lang = lang;
    const voices = speechSynthesis.getVoices();
    utter.voice = voices.find(v=>v.lang.includes(lang.slice(0,2))) || voices[0];
    speechSynthesis.speak(utter);
    addOutput(`üí¨ ${clean}`);
}

// Mostrar mensajes
function addOutput(msg){
    const div = document.getElementById('output');
    div.innerHTML += msg + '<br>';
    div.scrollTop = div.scrollHeight;
}

// Detecci√≥n autom√°tica de idioma
async function detectLanguage(text){
    try {
        const res = await fetch('/detect-language',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ text })
        });
        const data = await res.json();
        return data.language || 'es';
    } catch(e){ return 'es'; }
}

// Bot√≥n reproducir
document.getElementById('btnSpeak').addEventListener('click', async ()=>{
    const text = document.getElementById('txtInput').value;
    if(!text) return;
    const lang = await detectLanguage(text);
    speakText(text, lang);
});

// Bot√≥n hablar
document.getElementById('btnListen').addEventListener('click', ()=>{
    if(!recognition) return alert('Tu navegador no soporta reconocimiento de voz.');
    recognition.start();
});

if(recognition){
    recognition.onresult = async function(event){
        const transcript = event.results[0][0].transcript;
        addOutput(`üó£Ô∏è ${transcript}`);
        const lang = await detectLanguage(transcript);
        speakText(transcript, lang); // Responde autom√°ticamente
    };
    recognition.onerror = function(e){
        console.error(e);
        alert('Error de reconocimiento de voz: ' + e.error);
    };
}
</script>

</body>
</html>
